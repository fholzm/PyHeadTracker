image: astral/uv:alpine

variables:
  GIT_DEPTH: 0

build:
  stage: build
  script:
    - uv build
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz

.pypi-base:
  stage: 'deploy'
  script:
    - pip install twine
    - >-
    - python3 -m twine upload --username __token__ --password "${PYPI_REPO_TOKEN}" --repository "${PYPI_REPOSITORY}" dist/*

testpypi:
  extends: '.pypi-base'
  rules:
    # Only run if it's a pipeline for the default branch:
    - if: '$CI_COMMIT_BRANCH == "test"'
  environment:
    name: 'testpypi'
  variables:
    PYPI_REPOSITORY: 'testpypi'
    PYPI_REPO_TOKEN: ${PYPI_TEST_TOKEN}

pypi:
  extends: '.pypi-base'
  rules:
    # Only run in tag pipelines:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  environment:
    name: 'pypi'
    url: 'https://pypi.org/project/pyheadtracker/'
  variables:
    PYPI_REPOSITORY: 'pypi'
    PYPI_REPO_TOKEN: ${PYPI_TOKEN}
